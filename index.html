<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>çš‡å¸å¦ƒå­ç¿»ç‰Œæ¸¸æˆ - å…¨å±3Dçš‡å† ä¸èˆå°ç¯å…‰ç‰¹æ•ˆ</title>
    <!-- å¼•å…¥ Font Awesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #2c3e50 0%, #4a235a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #fff;
            overflow: hidden;
        }

        /* ========== ä¸»å®¹å™¨ ========== */
        .container {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.3);
            position: relative;
            min-height: 600px;
            height: calc(100vh - 40px);
            max-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ========== å…¨å±æŒ‰é’® ========== */
        .fullscreen-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 215, 0, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            border: 1px solid #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            z-index: 20;
            transition: all 0.3s ease;
            user-select: none;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 215, 0, 0.5);
            transform: scale(1.1);
        }

        /* ========== å†…åµŒæ»šåŠ¨åŒºåŸŸ ========== */
        #scrollable-area {
            position: relative;
            flex: 1;
            overflow: hidden;
            margin-top: 10px;
            border-radius: 10px;
            background: rgba(75, 0, 130, 0.1);
        }

        #content-wrapper {
            width: calc(100% - 20px);
            height: 100%;
            min-height: 0;
            overflow-y: auto;
            padding-right: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            display: block;
        }

        #content-wrapper::-webkit-scrollbar {
            display: none;
        }

        /* ========== æ»‘åŠ¨æ¡æ ·å¼ ========== */
        .inner-scrollbar-track {
            position: absolute;
            right: 10px;
            top: 10px;
            width: 8px;
            height: calc(100% - 20px);
            background: rgba(139, 0, 139, 0.3);
            border-radius: 4px;
            border: 1px solid #9370db;
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #scrollable-area:hover .inner-scrollbar-track,
        .inner-scrollbar-track.dragging {
            opacity: 0.8 !important;
        }

        .inner-scrollbar-thumb {
            position: absolute;
            left: 0;
            top: 0;
            width: 8px;
            background: linear-gradient(to bottom, #daa520, #ffd700);
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.7);
            cursor: ns-resize;
            opacity: 0.9;
        }

        /* ========== æ¸¸æˆç»„ä»¶é€šç”¨æ ·å¼ ========== */
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        h1 {
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            color: #ffd700;
            font-size: 2.5rem;
        }

        .crown-icon {
            font-size: 2.5rem;
            color: #ffd700;
        }

        .instructions {
            background: rgba(139, 0, 130, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: left;
            border: 1px solid #9370db;
        }

        .instructions h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            background: rgba(75, 0, 130, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #9370db;
            gap: 10px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-value {
            font-size: 1.8rem;
            color: #ffd700;
        }

        .level-info {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }

        .current-ranks {
            margin-top: 15px;
            padding: 10px;
            background: rgba(139, 0, 130, 0.2);
            border-radius: 10px;
            border: 1px solid #9370db;
        }

        /* ========== å¡ç‰‡ä¸æ¸¸æˆæ¿ ========== */
        .game-board {
            display: grid;
            grid-gap: 10px;
            margin: 0 auto 20px;
            max-width: 600px;
            justify-content: center;
            min-height: 100px;
        }

        .card {
            height: 100px;
            perspective: 1000px;
            cursor: pointer;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card.matched .card-inner {
            box-shadow: 0 0 15px gold;
        }

        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .card-back {
            background: linear-gradient(45deg, #daa520 0%, #ffd700 100%);
            font-size: 24px;
            color: #4b0082;
            border: 2px solid #ffd700;
        }

        .card-front {
            background: linear-gradient(45deg, #f8f8ff 0%, #e6e6fa 100%);
            transform: rotateY(180deg);
            padding: 8px;
            text-align: center;
            border: 2px solid #daa520;
        }

        .imperial-front {
            background: linear-gradient(45deg, #fff0f0 0%, #ffd6d6 100%);
            border: 2px solid #ff9999;
        }

        .rank {
            font-size: 14px;
            color: #8b0000;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .crowns {
            display: flex;
            justify-content: center;
            margin: 3px 0;
        }

        .crown {
            color: #ffd700;
            margin: 0 1px;
            font-size: 12px;
            text-shadow: 0px 0px 2px rgba(0, 0, 0, 0.5);
        }

        .ad-img {
            max-width: 85%;
            max-height: 45px;
            object-fit: contain;
            margin-bottom: 3px;
            border-radius: 5px;
            color: white;
            font-size: clamp(10px, 2.5vw, 16px); /* è‡ªé€‚åº”å­—ä½“å¤§å° */
            font-weight: bold;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.2;
        }

        .points {
            color: #ff4500;
            font-size: 12px;
            font-weight: bold;
        }

        .controls {
            margin-top: 25px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(45deg, #daa520 0%, #ffd700 100%);
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            color: #4b0082;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin-top: 20px;
            font-size: 1.3rem;
            font-weight: bold;
            min-height: 40px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 100, 0, 0.3);
            color: #7fff00;
            display: none;
            animation: fadeIn 1s;
        }

        .rankings {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .rank-item {
            background: rgba(255, 215, 0, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #daa520;
            font-size: 14px;
        }

        .level-selection {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .level-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(45deg, #daa520 0%, #ffd700 100%);
            color: #4b0082;
            cursor: pointer;
            transition: all 0.3s;
        }

        .level-btn:hover {
            transform: scale(1.1);
        }

        .level-btn.current {
            background: linear-gradient(45deg, #ff9999 0%, #ff4d4d 100%);
            color: white;
        }

        .level-btn.completed {
            background: linear-gradient(45deg, #4CAF50 0%, #2E7D32 100%);
            color: white;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pointsAnimation {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        .points-popup {
            position: absolute;
            color: #ff4500;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 1px 1px 2px black;
            z-index: 100;
            pointer-events: none;
            animation: pointsAnimation 1s ease-out forwards;
        }

        /* ============= 3Dçš‡å† å…¨å±åŠ¨ç”»æ ·å¼ ============= */
        
        /* --- åŸå§‹çš‡å† åŠ¨ç”»ï¼ˆä¿ç•™ä½œä¸ºå¤‡é€‰æˆ–fallbackï¼‰ --- */
        .crown-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 1000px;
        }

        .crown-burst {
            font-size: 100px;
            color: gold;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8),
                        0 0 40px rgba(255, 215, 0, 0.6),
                        0 0 60px rgba(255, 215, 0, 0.4);
            opacity: 0;
            transform: scale(0) rotate(0deg);
            transform-style: preserve-3d;
            animation: expandCrown 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .rank-queen .crown-burst {
            color: #FFD700;
            text-shadow: 0 0 30px #FFD700,
                        0 0 60px #FFD700,
                        0 0 90px #FFD700,
                        0 0 120px #FFEC8B;
            animation: expandCrown 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, pulseGlow 1.5s infinite alternate;
        }

        .rank-imperial-noble .crown-burst {
            color: #FFA500;
            text-shadow: 0 0 20px #FFA500, 0 0 40px #FF8C00;
        }

        .rank-noble .crown-burst {
            color: #C0C0C0;
            text-shadow: 0 0 20px #C0C0C0, 0 0 40px #D3D3D3;
        }

        .rank-consort .crown-burst {
            color: #FFFACD;
            text-shadow: 0 0 15px #FFFACD;
        }

        @keyframes expandCrown {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(8) rotate(180deg); opacity: 1; }
            100% { transform: scale(25) rotate(360deg); opacity: 0; }
        }

        @keyframes pulseGlow {
            from {
                text-shadow: 0 0 30px #FFD700, 0 0 60px #FFD700;
            }
            to {
                text-shadow: 0 0 50px #FFD700, 0 0 100px #FFD700, 0 0 150px #FFEC8B;
            }
        }

        /* --- æ–°å¢ï¼šæ›´çœŸå®çš„3Dçš‡å† åŠ¨ç”» --- */
        .three-dee-crown {
            position: relative;
            width: 100px; /* åˆå§‹å°ºå¯¸ */
            height: 60px;
            transform-style: preserve-3d;
            animation: expand3DCrown 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* çš‡å† ä¸»ä½“ */
        .crown-base {
            position: absolute;
            width: 100%;
            height: 20px;
            background: linear-gradient(to right, #D4AF37, #FFD700, #D4AF37);
            border-radius: 50% / 100% 100% 0 0;
            bottom: 0;
            left: 0;
            transform: translateZ(10px);
            box-shadow: 0 0 10px gold, 0 0 20px orange;
        }

        /* çš‡å† å°–åˆº */
        .spike {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 40px solid gold; /* é»˜è®¤é‡‘è‰² */
            top: -40px;
            left: 50%;
            transform-origin: bottom center;
            box-shadow: 0 0 5px gold;
        }

        .spike:nth-child(1) { left: 10%; transform: translateX(-50%) translateZ(20px); }
        .spike:nth-child(2) { left: 30%; transform: translateX(-50%) translateZ(25px); }
        .spike:nth-child(3) { left: 50%; transform: translateX(-50%) translateZ(30px); } /* ä¸­é—´æœ€é«˜ */
        .spike:nth-child(4) { left: 70%; transform: translateX(-50%) translateZ(25px); }
        .spike:nth-child(5) { left: 90%; transform: translateX(-50%) translateZ(20px); }

        /* çš‡å† å®çŸ³ */
        .gem {
            position: absolute;
            width: 15px;
            height: 15px;
            background: radial-gradient(circle at 30% 30%, #fff, #FF6B6B, #8B0000);
            border-radius: 50%;
            top: -10px;
            left: 50%;
            transform: translateX(-50%) translateZ(35px); /* åœ¨ä¸­é—´å°–åˆºä¸Š */
            box-shadow: 0 0 5px #FF6B6B, 0 0 15px #FF0000;
        }

        /* çš‡åçš‡å† ä½¿ç”¨çº¢è‰²å®çŸ³ */
        .rank-queen .gem {
            background: radial-gradient(circle at 30% 30%, #fff, #FF6B6B, #8B0000);
            box-shadow: 0 0 5px #FF6B6B, 0 0 15px #FF0000;
        }

        /* çš‡è´µå¦ƒçš‡å† ä½¿ç”¨è“è‰²å®çŸ³ */
        .rank-imperial-noble .gem {
            background: radial-gradient(circle at 30% 30%, #fff, #87CEEB, #1E90FF);
            box-shadow: 0 0 5px #87CEEB, 0 0 15px #1E90FF;
        }

        /* è´µå¦ƒçš‡å† ä½¿ç”¨ç»¿è‰²å®çŸ³ */
        .rank-noble .gem {
            background: radial-gradient(circle at 30% 30%, #fff, #98FB98, #32CD32);
            box-shadow: 0 0 5px #98FB98, 0 0 15px #32CD32;
        }

        /* å¦ƒåŠä»¥ä¸‹ä½¿ç”¨é»„è‰²å®çŸ³ */
        .rank-consort .gem,
        .rank-pin .gem,
        .rank-guiren .gem,
        .rank-changzai .gem,
        .rank-daying .gem {
            background: radial-gradient(circle at 30% 30%, #fff, #FFD700, #DAA520);
            box-shadow: 0 0 5px #FFD700, 0 0 15px #DAA520;
        }

        /* 3Dçš‡å† å±•å¼€åŠ¨ç”» */
        @keyframes expand3DCrown {
            0% {
                transform: scale(0) rotateY(0deg) rotateX(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(2) rotateY(180deg) rotateX(10deg);
                opacity: 1;
            }
            100% {
                transform: scale(8) rotateY(360deg) rotateX(20deg);
                opacity: 0;
            }
        }


        /* ========== æç¤ºé«˜äº®åŠ¨ç”» ========== */
        .card.highlight {
            animation: highlightPulse 1s ease-in-out;
        }

        @keyframes highlightPulse {
            0% { box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(255, 215, 0, 0.8), 0 0 20px gold; }
            100% { box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.4); }
        }

        /* ========== èˆå°ç¯å…‰æ•ˆæœ ========== */
        #stage-lights {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998; /* åœ¨çš‡å† åŠ¨ç”»ä¸‹æ–¹ */
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #stage-lights.active {
            opacity: 1;
        }

        .light-beam {
            position: absolute;
            width: 100px;
            height: 100vh;
            background: conic-gradient(
                transparent,
                rgba(255, 215, 0, 0.5),
                rgba(255, 105, 180, 0.5),
                rgba(0, 191, 255, 0.5),
                rgba(50, 205, 50, 0.5),
                transparent
            );
            filter: blur(30px);
            opacity: 0.7;
            animation: rotateLights 10s linear infinite;
        }

        .light-beam:nth-child(2) {
            animation-delay: -2s;
            background: conic-gradient(
                transparent,
                rgba(255, 105, 180, 0.5),
                rgba(0, 191, 255, 0.5),
                rgba(50, 205, 50, 0.5),
                rgba(255, 215, 0, 0.5),
                transparent
            );
        }

        .light-beam:nth-child(3) {
            animation-delay: -4s;
            background: conic-gradient(
                transparent,
                rgba(0, 191, 255, 0.5),
                rgba(50, 205, 50, 0.5),
                rgba(255, 215, 0, 0.5),
                rgba(255, 105, 180, 0.5),
                transparent
            );
        }

        .light-beam:nth-child(4) {
            animation-delay: -6s;
            background: conic-gradient(
                transparent,
                rgba(50, 205, 50, 0.5),
                rgba(255, 215, 0, 0.5),
                rgba(255, 105, 180, 0.5),
                rgba(0, 191, 255, 0.5),
                transparent
            );
        }

        @keyframes rotateLights {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========== å“åº”å¼é€‚é… ========== */
        @media (max-width: 600px) {
            .container {
                padding: 15px;
                min-height: 500px;
                height: calc(100vh - 10px);
            }

            .header {
                gap: 10px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .game-info {
                grid-template-columns: 1fr 1fr;
                font-size: 1rem;
            }

            .info-value {
                font-size: 1.5rem;
            }

            .game-board {
                grid-template-columns: repeat(4, 1fr);
                grid-gap: 6px;
            }

            .card {
                height: 80px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            button {
                width: 100%;
                justify-content: center;
                font-size: 15px;
            }

            .rankings {
                flex-direction: column;
                align-items: center;
                font-size: 13px;
            }

            .fullscreen-btn {
                top: 10px;
                right: 10px;
                width: 36px;
                height: 36px;
                font-size: 16px;
            }

            .inner-scrollbar-track {
                right: 8px;
            }
        }
    </style>
</head>
<body>

<!-- èˆå°ç¯å…‰å®¹å™¨ -->
<div id="stage-lights"></div>

<div class="container">

    <div class="fullscreen-btn" id="fullscreen-btn" title="è¿›å…¥å…¨å±">
        <i class="fas fa-expand"></i>
    </div>

    <div id="scrollable-area" class="clickable-area">
        <div id="content-wrapper">

            <div class="header">
                <i class="crown-icon fas fa-crown"></i>
                <h1>çš‡å¸å¦ƒå­ç¿»ç‰Œæ¸¸æˆ</h1>
                <i class="crown-icon fas fa-crown"></i>
            </div>

            <div class="instructions">
                <h3><i class="fas fa-info-circle"></i> æ¸¸æˆè§„åˆ™</h3>
                <p><strong>ğŸ¯ æ ¸å¿ƒç©æ³•ï¼š</strong>ç¿»å¼€ä¸¤å¼ å¡ç‰‡ï¼Œè‹¥å¹¿å‘Šå›¾ç‰‡ç›¸åŒï¼Œåˆ™ä¿æŒç¿»å¼€ï¼›è‹¥ä¸åŒåˆ™ç¿»å›ã€‚åŒ¹é…<strong>æ‰€æœ‰</strong>å¹¿å‘Šå¯¹å³å¯è·èƒœã€‚</p>
                <p><strong>ğŸ‘¸ å¦ƒå­ç³»ç»Ÿï¼š</strong>åœºä¸Šæœ‰éšæœºå¦ƒå­å¡ï¼Œç¿»å¼€åå¯æŸ¥çœ‹èº«ä»½ï¼Œå¹¶<strong>ç«‹å³å¢åŠ æ¸¸æˆæ—¶é—´</strong>ï¼ˆçš‡å+10ç§’ï¼Œç­”åº”+2ç§’ï¼‰ã€‚</p>
                <p><strong>ğŸ’° ç§¯åˆ†æœºåˆ¶ï¼š</strong>å¦ƒå­ç§¯åˆ†ä¸ä¼šç«‹åˆ»åˆ°è´¦ï¼Œå¿…é¡»<strong>é€šå…³æˆåŠŸå</strong>æ‰èƒ½å°†æ‰€æœ‰å·²ç¿»å¼€çš„å¦ƒå­ç§¯åˆ†ç´¯åŠ è‡³æ€»åˆ†ã€‚</p>
                <p><strong>â±ï¸ æ—¶é—´ç­–ç•¥ï¼š</strong>å–„ç”¨å¦ƒå­å¡äº‰å–æ›´å¤šæ—¶é—´ï¼Œä½†æ³¨æ„æ¯å…³æ—¶é—´æœ€å¤šä¸è¶…è¿‡åˆå§‹æ—¶é—´çš„ä¸¤å€ã€‚</p>
                <p><strong>ğŸ’¡ æç¤ºåŠŸèƒ½ï¼š</strong>ç‚¹å‡»ã€æç¤ºã€‘æŒ‰é’®å¯é«˜äº®ä¸€å¯¹å¯åŒ¹é…çš„å¹¿å‘Šå¡ï¼ˆå…±3æ¬¡æœºä¼šï¼‰ã€‚</p>
            </div>

            <div class="game-info">
                <div class="info-item">
                    <div>å¹¿å‘ŠåŒ¹é…å¯¹æ•°</div>
                    <div class="info-value" id="ads-matched">0</div>
                    <div id="total-ad-pairs">/?</div>
                </div>
                <div class="info-item">
                    <div>å°è¯•æ¬¡æ•°</div>
                    <div class="info-value" id="attempts">0</div>
                </div>
                <div class="info-item">
                    <div>æ€»ç§¯åˆ†</div>
                    <div class="info-value" id="total-points">0</div>
                </div>
                <div class="level-info">
                    <div>å…³å¡: <span id="current-level">1</span>/15</div>
                    <div>æ—¶é—´: <span id="time-left">60</span>ç§’</div>
                    <div>ç›®æ ‡: <span id="target-pairs">?</span>å¯¹</div>
                </div>
            </div>

            <div class="current-ranks">
                <h3>æœ¬å±€å¦ƒå­å¡ç‰‡</h3>
                <div id="current-ranks-container"></div>
            </div>

            <div class="game-board" id="game-board"></div>

            <div class="level-selection" id="level-selection"></div>

            <div class="rankings">
                <div class="rank-item">çš‡å: 50ç§¯åˆ† <i class="fas fa-crown"></i><i class="fas fa-crown"></i><i class="fas fa-crown"></i></div>
                <div class="rank-item">çš‡è´µå¦ƒ: 40ç§¯åˆ† <i class="fas fa-crown"></i><i class="fas fa-crown"></i></div>
                <div class="rank-item">è´µå¦ƒ: 30ç§¯åˆ† <i class="fas fa-crown"></i></div>
                <div class="rank-item">å¦ƒ: 20ç§¯åˆ†</div>
                <div class="rank-item">å«”: 10ç§¯åˆ†</div>
                <div class="rank-item">è´µäºº: 5ç§¯åˆ†</div>
                <div class="rank-item">å¸¸åœ¨: 3ç§¯åˆ†</div>
                <div class="rank-item">ç­”åº”: 2ç§¯åˆ†</div>
            </div>

            <div class="controls">
                <button id="restart"><i class="fas fa-redo"></i> é‡æ–°å¼€å§‹</button>
                <button id="hint"><i class="fas fa-lightbulb"></i> æç¤º (<span id="hint-count">3</span>)</button>
                <button id="next-level" disabled><i class="fas fa-arrow-right"></i> ä¸‹ä¸€å…³</button>
            </div>

            <div class="result" id="result"></div>

        </div>

        <div class="inner-scrollbar-track">
            <div class="inner-scrollbar-thumb" id="scroll-thumb"></div>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const contentWrapper = document.getElementById('content-wrapper');
        const scrollThumb = document.getElementById('scroll-thumb');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const scrollableArea = document.getElementById('scrollable-area');
        const stageLights = document.getElementById('stage-lights');

        let isDragging = false;
        let touchStartY = 0;

        function updateThumb() {
            if (!contentWrapper || !scrollThumb) return;
            const { scrollTop, scrollHeight, clientHeight } = contentWrapper;
            const totalScrollable = scrollHeight - clientHeight;

            if (totalScrollable <= 0) {
                document.querySelector('.inner-scrollbar-track').style.display = 'none';
                return;
            } else {
                document.querySelector('.inner-scrollbar-track').style.display = 'block';
            }

            const thumbHeight = Math.max((clientHeight / scrollHeight) * clientHeight, 20);
            const maxTop = clientHeight - thumbHeight;
            const ratio = scrollTop / totalScrollable;
            const thumbTop = ratio * maxTop;

            scrollThumb.style.height = `${thumbHeight}px`;
            scrollThumb.style.top = `${thumbTop}px`;
        }

        contentWrapper.addEventListener('scroll', updateThumb);

        scrollThumb.addEventListener('mousedown', e => {
            isDragging = true;
            const startY = e.clientY;
            const startTop = parseInt(window.getComputedStyle(scrollThumb).top, 10);
            scrollThumb.classList.add('dragging');
            document.querySelector('.inner-scrollbar-track').style.opacity = '1';

            const onMove = moveEvent => {
                if (!isDragging) return;
                const dy = moveEvent.clientY - startY;
                const maxTop = contentWrapper.clientHeight - scrollThumb.offsetHeight;
                const newTop = Math.max(0, Math.min(maxTop, startTop + dy));
                const ratio = newTop / maxTop;
                contentWrapper.scrollTop = ratio * (contentWrapper.scrollHeight - contentWrapper.clientHeight);
            };

            const upHandler = () => {
                isDragging = false;
                scrollThumb.classList.remove('dragging');
                document.querySelector('.inner-scrollbar-track').style.opacity = '';
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', upHandler);
            };

            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', upHandler);
        });

        document.querySelector('.inner-scrollbar-track').addEventListener('click', e => {
            const trackRect = e.currentTarget.getBoundingClientRect();
            const clickY = e.clientY - trackRect.top;
            const thumbH = scrollThumb.offsetHeight;
            const targetRatio = (clickY - thumbH / 2) / (trackRect.height - thumbH);
            const targetScroll = targetRatio * (contentWrapper.scrollHeight - contentWrapper.clientHeight);
            contentWrapper.scrollTop = targetScroll;
        });

        function initAndResize() {
            requestAnimationFrame(updateThumb);
        }

        initAndResize();
        window.addEventListener('resize', initAndResize);

        // ======================== å…¨å± ========================
        scrollableArea.addEventListener('dblclick', toggleFullscreen);
        fullscreenBtn.addEventListener('click', toggleFullscreen);

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.error("æ— æ³•è¿›å…¥å…¨å±:", e));
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                fullscreenBtn.title = "é€€å‡ºå…¨å±";
            } else {
                document.exitFullscreen();
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                fullscreenBtn.title = "è¿›å…¥å…¨å±";
            }
            setTimeout(updateThumb, 100);
        }

        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
            } else {
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            }
            setTimeout(updateThumb, 100);
        });

        // ======== è§¦å±æ‹–æ‹½æ”¯æŒ ========
        contentWrapper.addEventListener('touchstart', e => {
            touchStartY = e.touches[0].clientY;
        }, { passive: false });

        contentWrapper.addEventListener('touchmove', e => {
            const dy = e.touches[0].clientY - touchStartY;
            touchStartY = e.touches[0].clientY;
            contentWrapper.scrollTop -= dy;
            updateThumb();
            e.preventDefault();
        }, { passive: false });

        // ======== æ¸¸æˆé€»è¾‘ ========
        const gameBoard = document.getElementById('game-board');
        const restartButton = document.getElementById('restart');
        const hintButton = document.getElementById('hint');
        const nextLevelButton = document.getElementById('next-level');
        const adsMatchedElement = document.getElementById('ads-matched'); // ä¿®æ”¹ä¸ºå¹¿å‘ŠåŒ¹é…è®¡æ•°
        const attemptsElement = document.getElementById('attempts');
        const totalPointsElement = document.getElementById('total-points');
        const resultElement = document.getElementById('result');
        const currentRanksContainer = document.getElementById('current-ranks-container');
        const currentLevelElement = document.getElementById('current-level');
        const timeLeftElement = document.getElementById('time-left');
        const targetPairsElement = document.getElementById('target-pairs');
        const totalAdPairsElement = document.getElementById('total-ad-pairs'); // ä¿®æ”¹ä¸ºæ€»å¹¿å‘Šå¯¹æ•°
        const hintCountElement = document.getElementById('hint-count');
        const levelSelectionContainer = document.getElementById('level-selection');

        let cards = [];
        let flippedCards = [];
        let adsMatched = 0; // æ–°å¢ï¼šç”¨äºè®¡æ•°æ‰€æœ‰åŒ¹é…æˆåŠŸçš„å¹¿å‘Šå¯¹
        let totalAdPairs = 0; // æ–°å¢ï¼šåœºä¸Šæ‰€æœ‰å¹¿å‘Šå¯¹çš„æ•°é‡
        let attempts = 0;
        let totalPoints = 0;
        let gameCompleted = false;
        let selectedRanks = [];
        let currentLevel = 1;
        let timeLeft = 0;
        let timer = null;
        let hintsRemaining = 3;
        let completedLevels = [];
        let collectedImperialPoints = 0;
        let targetPairsCount = 0; // ç›®æ ‡å¹¿å‘Šå¯¹æ•°é‡ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰

        // ç½‘æ ¼é…ç½® [è¡Œ, åˆ—]
        const gridSizeConfig = [
            null,
            [3,3], [3,3], [3,3],
            [4,4], [4,4], [4,4], [4,4],
            [5,5], [5,5], [5,5],
            [6,6], [6,6], [6,6],
            [7,7], [7,7]
        ];

        // å¦ƒå­åŠ æ—¶
        const imperialTimeBonus = {
            "çš‡å": 10, "çš‡è´µå¦ƒ": 8, "è´µå¦ƒ": 6, "å¦ƒ": 5,
            "å«”": 4, "è´µäºº": 3, "å¸¸åœ¨": 2, "ç­”åº”": 2
        };

        const ranks = [
            { name: "çš‡å", points: 50, crowns: 3 },
            { name: "çš‡è´µå¦ƒ", points: 40, crowns: 2 },
            { name: "è´µå¦ƒ", points: 30, crowns: 1 },
            { name: "å¦ƒ", points: 20, crowns: 0 },
            { name: "å«”", points: 10, crowns: 0 },
            { name: "è´µäºº", points: 5, crowns: 0 },
            { name: "å¸¸åœ¨", points: 3, crowns: 0 },
            { name: "ç­”åº”", points: 2, crowns: 0 }
        ];

        const adImages = [
            { name: "å¯å£å¯ä¹", color: "#FF6B6B" }, { name: "Nike", color: "#4ECDC4" },
            { name: "å°ç±³", color: "#FFE66D" }, { name: "åä¸º", color: "#9b59b6" },
            { name: "è‹¹æœ", color: "#3498db" }, { name: "ç¿ å±æ±‡", color: "#2ecc71" },
            { name: "çº¢è±†", color: "#e74c3c" }, { name: "æ–°æ—¥ç”µåŠ¨è½¦", color: "#1abc9c" },
            { name: "KFC", color: "#f39c12" }, { name: "éº¦å½“åŠ³", color: "#d35400" },
            { name: "å®é©¬", color: "#34495e" }, { name: "å¥”é©°", color: "#8e44ad" },
            { name: "ä¹äº‹", color: "#8e44ad" }, { name: "è‹—å°å›", color: "#8e44ad" },
            { name: "å¸Œå°”é¡¿", color: "#8e44ad" }, { name: "è’™ç‰›", color: "#8e44ad" },
            { name: "ä¼Šåˆ©", color: "#8e44ad" }, { name: "å…‰æ˜", color: "#8e44ad" },
            { name: "é”¡ç¬¼è®°", color: "#8e44ad" }, { name: "æ³¡æ³¡ç›ç‰¹", color: "#8e44ad" }
        ];

        function initLevelSelection() {
            levelSelectionContainer.innerHTML = '';
            for (let i = 1; i <= 15; i++) {
                const btn = document.createElement('div');
                btn.className = 'level-btn';
                if (i === currentLevel) btn.classList.add('current');
                else if (completedLevels.includes(i)) btn.classList.add('completed');
                btn.textContent = i;
                btn.addEventListener('click', () => {
                    if (i <= completedLevels.length + 1) startLevel(i);
                });
                levelSelectionContainer.appendChild(btn);
            }
        }

        function startLevel(level) {
            clearInterval(timer);
            currentLevel = level;
            const [rows, cols] = gridSizeConfig[level];
            const totalSlots = rows * cols;
            const basePairs = Math.floor(totalSlots * 0.4); // ç›®æ ‡å¹¿å‘Šå¯¹æ•° â‰ˆ 40%
            const imperialCount = Math.min(Math.ceil(level / 3), 5); // æœ€å¤š5ä¸ªå¦ƒå­
            const timeLimit = 60 + level * 10;
            const baseReward = 50 + level * 10;

            gameBoard.innerHTML = '';
            cards = []; flippedCards = []; adsMatched = 0; attempts = 0; // é‡ç½® adsMatched
            gameCompleted = false; hintsRemaining = 3; collectedImperialPoints = 0;

            adsMatchedElement.textContent = '0'; // æ›´æ–°UI
            attemptsElement.textContent = '0';
            resultElement.style.display = 'none';
            hintCountElement.textContent = hintsRemaining;
            hintButton.disabled = false;

            currentLevelElement.textContent = level;
            timeLeft = timeLimit;
            timeLeftElement.textContent = timeLeft;
            
            // è®¾ç½®ç›®æ ‡å¹¿å‘Šå¯¹æ•°é‡ï¼ˆä»…ç”¨äºæ˜¾ç¤ºï¼‰
            targetPairsCount = basePairs;
            targetPairsElement.textContent = targetPairsCount;
            // totalAdPairsElement.textContent = `/ ${targetPairsCount}`; // åˆå§‹åŒ–ä¸º ?ï¼Œåé¢ä¼šæ›´æ–°

            // é€‰æ‹©å¦ƒå­
            const availableRanks = [...ranks];
            selectedRanks = [];
            for (let i = 0; i < imperialCount; i++) {
                const idx = Math.floor(Math.random() * availableRanks.length);
                selectedRanks.push(availableRanks[idx]);
                availableRanks.splice(idx, 1);
            }

            currentRanksContainer.innerHTML = selectedRanks.map(r => {
                const crowns = '<i class="fas fa-crown" style="color:#ffd700;margin:0 2px;"></i>'.repeat(r.crowns);
                return `<span style="margin:10px;color:#ffd700">${r.name}(+${r.points})${crowns}</span>`;
            }).join('');

            // å¹¿å‘Šæ˜ å°„
            const shuffledAds = shuffleArray([...adImages]);
            const selectedAdImages = shuffledAds.slice(0, basePairs);
            const adValueToImageMap = new Map();
            
            // ä¸ºæ¯ä¸ªç›®æ ‡å¹¿å‘Šå¯¹åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ value (ä» 0 å¼€å§‹)
            for (let i = 0; i < basePairs; i++) {
                adValueToImageMap.set(i, selectedAdImages[i]);
            }

            let cardValues = [];

            // æ·»åŠ ç›®æ ‡å¹¿å‘Šå¯¹ (ä½¿ç”¨ä» 0 å¼€å§‹çš„å”¯ä¸€ value)
            for (let i = 0; i < basePairs; i++) {
                cardValues.push({ type: 'ad', value: i, isTarget: true });
                cardValues.push({ type: 'ad', value: i, isTarget: true });
            }

            // æ·»åŠ å¦ƒå­
            selectedRanks.forEach(r => {
                cardValues.push({ type: 'imperial', value: r });
            });

            // è®¡ç®—éœ€è¦å¤šå°‘å¡«å……å¡ç‰Œ
            const remainingSlots = totalSlots - cardValues.length;
            
            if (remainingSlots > 0) {
                // è®¡ç®—éœ€è¦å¤šå°‘å¯¹å¡«å……å¡ç‰Œ
                const fillerPairsNeeded = Math.floor(remainingSlots / 2);
                
                // ä»å¹¿å‘Šæ± ä¸­é€‰æ‹©å¡«å……å¹¿å‘Šï¼ˆæ’é™¤å·²é€‰ä¸­çš„ç›®æ ‡å¹¿å‘Šï¼‰
                const fillerPool = adImages.filter(a => !selectedAdImages.includes(a));
                
                // å¦‚æœå¡«å……æ± ä¸å¤Ÿï¼Œå…è®¸é‡å¤ä½¿ç”¨å¹¿å‘Š
                let expandedFillerPool = [...fillerPool];
                if (expandedFillerPool.length < fillerPairsNeeded) {
                    const needed = fillerPairsNeeded - expandedFillerPool.length;
                    for (let i = 0; i < needed; i++) {
                        expandedFillerPool.push(...fillerPool);
                    }
                }
                
                // æ‰“ä¹±å¡«å……æ± 
                shuffleArray(expandedFillerPool);
                
                // ä¸ºæ¯å¯¹å¡«å……å¡ç‰Œåˆ†é…å”¯ä¸€å€¼
                const fillerStartValue = basePairs + selectedRanks.length; // ç¡®ä¿ä¸ä¸ç›®æ ‡å¹¿å‘Šå’Œå¦ƒå­å†²çª
                for (let i = 0; i < fillerPairsNeeded; i++) {
                    const ad = expandedFillerPool[i % expandedFillerPool.length];
                    const value = fillerStartValue + i;
                    // æ·»åŠ ä¸€å¯¹å¡«å……å¡ç‰Œ
                    cardValues.push({ 
                        type: 'ad', 
                        value: value, 
                        isTarget: false, 
                        fillerAd: ad 
                    });
                    cardValues.push({ 
                        type: 'ad', 
                        value: value, 
                        isTarget: false, 
                        fillerAd: ad 
                    });
                }
                
                // å¦‚æœæœ‰å¥‡æ•°ä¸ªå‰©ä½™æ§½ä½ï¼Œæ·»åŠ ä¸€ä¸ªå¦ƒå­å¡ï¼ˆç¡®ä¿æ€»å¡æ•°æ­£ç¡®ï¼‰
                if (remainingSlots % 2 === 1) {
                    // ä»å¯ç”¨å¦ƒå­ä¸­éšæœºé€‰æ‹©ä¸€ä¸ª
                    const randomRank = availableRanks.length > 0 
                        ? availableRanks[Math.floor(Math.random() * availableRanks.length)]
                        : ranks[Math.floor(Math.random() * ranks.length)];
                    cardValues.push({ type: 'imperial', value: randomRank });
                }
            }

            shuffleArray(cardValues);

            // è®¾ç½®ç½‘æ ¼
            gameBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

            cardValues.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';

                let crownIcons = '';
                if (item.type === 'imperial') {
                    for (let i = 0; i < item.value.crowns; i++) {
                        crownIcons += '<i class="crown fas fa-crown"></i>';
                    }
                }

                // ç¡®å®šè¦æ˜¾ç¤ºçš„å¹¿å‘Šä¿¡æ¯
                let adInfo = null;
                if (item.type === 'ad' && item.isTarget) {
                    adInfo = adValueToImageMap.get(item.value);
                } else if (item.type === 'ad' && !item.isTarget && item.fillerAd) {
                    // ä½¿ç”¨å¡«å……å¡æ± ä¸­çš„å¹¿å‘Šä¿¡æ¯
                    adInfo = item.fillerAd;
                } else if (item.type === 'ad' && !item.isTarget) {
                     // fallback: å¦‚æœæ²¡æœ‰ fillerAd ä¿¡æ¯ï¼Œåˆ™ä»åŸå§‹ adImages ä¸­éšæœºé€‰ä¸€ä¸ª
                    console.warn("Fallback: ä½¿ç”¨éšæœºå¹¿å‘Šå¡«å……", item);
                    adInfo = adImages[Math.floor(Math.random() * adImages.length)];
                }

                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-back">?</div>
                        <div class="card-front ${item.type === 'imperial' ? 'imperial-front' : ''}">
                            ${item.type === 'imperial' ?
                                `<div class="rank">${item.value.name}</div>
                                 <div class="crowns">${crownIcons}</div>
                                 <div class="points">+${item.value.points}ç§¯åˆ†</div>` :
                                `<div class="ad-img" style="background:${adInfo?.color || '#ccc'}">
                                    ${adInfo?.name || 'å¹¿å‘Š'}
                                 </div>`
                            }
                        </div>
                    </div>
                `;

                card.dataset.type = item.type;
                // ä¿®å¤ï¼šå¦ƒå­å¡çš„ value æ˜¯å¯¹è±¡ï¼Œä¸èƒ½ç›´æ¥ toString
                if (item.type === 'imperial') {
                    card.dataset.value = item.value.name; // ä½¿ç”¨å¦ƒå­åç§°ä½œä¸ºå”¯ä¸€æ ‡è¯†
                    card.dataset.rank = item.value.name;
                    card.dataset.points = item.value.points;
                } else {
                    card.dataset.value = item.value.toString();
                    card.dataset.isTarget = item.isTarget ? 'true' : 'false';
                }

                card.addEventListener('click', () => flipCard(card));
                gameBoard.appendChild(card);
                cards.push(card);
            });

            // è®¡ç®—æ€»å¹¿å‘Šå¯¹æ•°å¹¶åœ¨UIä¸Šæ˜¾ç¤º
            totalAdPairs = cardValues.filter(c => c.type === 'ad').length / 2;
            totalAdPairsElement.textContent = `/ ${totalAdPairs}`; // æ›´æ–°UIæ˜¾ç¤ºæ€»å¹¿å‘Šå¯¹æ•°

            initLevelSelection();
            nextLevelButton.disabled = true;

            timer = setInterval(() => {
                timeLeft--;
                timeLeftElement.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    gameCompleted = true;
                    resultElement.style.display = 'block';
                    resultElement.textContent = `æ—¶é—´åˆ°ï¼æ¸¸æˆå¤±è´¥ã€‚`;
                    resultElement.style.background = 'rgba(139,0,0,0.3)';
                    resultElement.style.color = '#ff6b6b';
                }
            }, 1000);
        }


        // åˆ›å»ºèˆå°ç¯å…‰
        function createStageLights() {
            stageLights.innerHTML = ''; // æ¸…ç©ºç°æœ‰ç¯å…‰
            for (let i = 0; i < 4; i++) {
                const beam = document.createElement('div');
                beam.className = 'light-beam';
                // éšæœºä½ç½®
                beam.style.left = `${Math.random() * 100}%`;
                stageLights.appendChild(beam);
            }
        }

        // æ¿€æ´»èˆå°ç¯å…‰
        function activateStageLights(duration = 3000) {
            stageLights.classList.add('active');
            setTimeout(() => {
                stageLights.classList.remove('active');
            }, duration);
        }

        function flipCard(card) {
            if (gameCompleted || card.classList.contains('flipped') ||
                (flippedCards.length >= 2 && card.dataset.type !== 'imperial')) return;

            if (card.dataset.type === 'imperial') {
                if (!card.classList.contains('flipped')) {
                    card.classList.add('flipped');
                    card.classList.add('matched');
                    const points = parseInt(card.dataset.points);
                    collectedImperialPoints += points;
                    const bonusSeconds = imperialTimeBonus[card.dataset.rank] || 2;
                    const maxTime = 60 + currentLevel * 10;
                    timeLeft = Math.min(timeLeft + bonusSeconds, maxTime);
                    timeLeftElement.textContent = timeLeft;
                    showPointsAnimation(card, points);
                    // ä½¿ç”¨æ–°çš„ 3D çš‡å† åŠ¨ç”»
                    trigger3DCrownAnimation(card, card.dataset.rank);
                    
                    // æ¿€æ´»èˆå°ç¯å…‰
                    createStageLights(); // æ¯æ¬¡ç¿»å¦ƒå­éƒ½é‡æ–°ç”Ÿæˆç¯å…‰ä½ç½®
                    activateStageLights(3000); // æŒç»­3ç§’
                }
                return;
            }

            if (flippedCards.length >= 2) return;

            card.classList.add('flipped');
            flippedCards.push(card);

            if (flippedCards.length === 2) {
                attempts++;
                attemptsElement.textContent = attempts;
                setTimeout(() => {
                    const [c1, c2] = flippedCards;
                    if (c1.dataset.value === c2.dataset.value) {
                        c1.classList.add('matched'); c2.classList.add('matched');
                        
                        // ä¿®æ”¹ï¼šæ— è®ºæ˜¯å¦æ˜¯ç›®æ ‡å¹¿å‘Šï¼Œåªè¦åŒ¹é…æˆåŠŸå°±å¢åŠ  adsMatched è®¡æ•°å™¨
                        adsMatched++;
                        adsMatchedElement.textContent = adsMatched;
                        
                        // ä¿®æ”¹ï¼šè¿‡å…³æ¡ä»¶æ”¹ä¸ºåŒ¹é…æ‰€æœ‰å¹¿å‘Šå¯¹
                        if (adsMatched === totalAdPairs) {
                            gameCompleted = true;
                            clearInterval(timer);
                            const reward = 50 + currentLevel * 10;
                            totalPoints += reward + collectedImperialPoints;
                            totalPointsElement.textContent = totalPoints;
                            if (!completedLevels.includes(currentLevel)) completedLevels.push(currentLevel);
                            resultElement.style.display = 'block';
                            resultElement.textContent = `æ­å–œï¼ç¬¬${currentLevel}å…³å®Œæˆï¼è·å¾—${reward}+${collectedImperialPoints}=æ€»${reward+collectedImperialPoints}åˆ†`;
                            nextLevelButton.disabled = false;
                        }
                    } else {
                        c1.classList.remove('flipped'); c2.classList.remove('flipped');
                    }
                    flippedCards = [];
                }, 1000);
            }
        }

        hintButton.addEventListener('click', () => {
            if (hintsRemaining <= 0 || gameCompleted) return;
            hintsRemaining--;
            hintCountElement.textContent = hintsRemaining;
            hintButton.disabled = hintsRemaining <= 0;

            // ä¿®æ”¹ï¼šæç¤ºåŠŸèƒ½å¯»æ‰¾æ‰€æœ‰æœªåŒ¹é…çš„å¹¿å‘Šå¯¹
            const allValueMap = new Map();
            cards.forEach(c => {
                if (!c.classList.contains('matched') && !c.classList.contains('flipped') && 
                    c.dataset.type === 'ad') {
                    const v = c.dataset.value;
                    if (!allValueMap.has(v)) allValueMap.set(v, []);
                    allValueMap.get(v).push(c);
                }
            });

            let pair = null;
            for (const [v, list] of allValueMap) {
                if (list.length === 2) { pair = list; break; }
            }

            if (pair) {
                pair.forEach(c => c.classList.add('highlight'));
                setTimeout(() => pair.forEach(c => c.classList.remove('highlight')), 1000);
            }
        });

        function showPointsAnimation(card, points) {
            const p = document.createElement('div');
            p.className = 'points-popup';
            p.textContent = `+${points}`;
            const r = card.getBoundingClientRect();
            p.style.left = `${r.left + r.width/2}px`;
            p.style.top = `${r.top}px`;
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1000);
        }

        // --- ä¿®æ”¹ï¼šä½¿ç”¨æ–°çš„ 3D çš‡å† åŠ¨ç”»å‡½æ•° ---
        function trigger3DCrownAnimation(card, rankName) {
            const container = document.createElement('div');
            container.className = 'crown-animation-container';

            // åˆ›å»ºæ–°çš„ 3D çš‡å† å…ƒç´ 
            const crown3D = document.createElement('div');
            crown3D.className = 'three-dee-crown';

            // æ ¹æ®å¦ƒå­ç­‰çº§æ·»åŠ ä¸åŒçš„ç±»ï¼Œä»¥åº”ç”¨ä¸åŒçš„å®çŸ³é¢œè‰²
            const rankClassMap = {
                "çš‡å": "rank-queen",
                "çš‡è´µå¦ƒ": "rank-imperial-noble",
                "è´µå¦ƒ": "rank-noble",
                "å¦ƒ": "rank-consort",
                "å«”": "rank-pin",
                "è´µäºº": "rank-guiren",
                "å¸¸åœ¨": "rank-changzai",
                "ç­”åº”": "rank-daying"
            };
            const rankClass = rankClassMap[rankName] || "rank-consort";
            crown3D.classList.add(rankClass);

            // åˆ›å»ºçš‡å† çš„å„ä¸ªéƒ¨åˆ†
            const base = document.createElement('div');
            base.className = 'crown-base';
            crown3D.appendChild(base);

            for (let i = 0; i < 5; i++) {
                const spike = document.createElement('div');
                spike.className = 'spike';
                // å¯ä»¥ä¸ºä¸åŒç­‰çº§çš„å¦ƒå­è®¾ç½®ä¸åŒçš„å°–åˆºé¢œè‰²ï¼ˆå¦‚æœéœ€è¦ï¼‰
                // if (rankName === 'çš‡å') spike.style.borderBottomColor = '#FF6B6B'; 
                crown3D.appendChild(spike);
            }

            const gem = document.createElement('div');
            gem.className = 'gem';
            crown3D.appendChild(gem);

            container.appendChild(crown3D);
            document.body.appendChild(container);

            // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                if (container.parentNode) {
                    container.parentNode.removeChild(container);
                }
            }, 1500); // ä¸CSSåŠ¨ç”»æ—¶é•¿ä¸€è‡´
        }


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        restartButton.addEventListener('click', () => startLevel(currentLevel));
        nextLevelButton.addEventListener('click', () => {
            if (currentLevel < 15) startLevel(currentLevel + 1);
        });

        initLevelSelection();
        startLevel(1);
    });
</script>

</body>
</html>
